# 夜間行動系統重構說明

## 重構概述

將「按玩家逐個行動」的設計重構為「按角色順序行動」，從而防止其他玩家透過 UI 觀察得知是哪位玩家正在行動。

---

## 關鍵變數定義

### 1. 角色順序陣列（新增）
```javascript
const ROLE_NIGHT_ORDER = ['爪牙', '狼人', '失眠者', '先知', '強盜', '搗蛋鬼', '酒鬼'];
```

### 2. 狀態變數修改
```javascript
// 舊：currentNightPlayerIndex (玩家索引)
// 新：currentRoleIndex (角色索引)
state.currentRoleIndex = 0;
```

---

## 核心函式對比

### 舊系統（玩家逐個行動）
```
startNightPhase()
  ↓
processNextNightPlayer()          // 遍歷玩家陣列
  ↓
displayNightPlayer(player)        // 顯示「目前行動：[玩家名稱]」
  ↓
activateSkill(player)             // 執行玩家技能
  ↓
nextNightAction()
  ↓ (重複直到所有玩家處理完)
endNightPhase()
```

### 新系統（角色順序行動）
```
startNightPhase()
  ↓
processNextNightAction()          // 從順序陣列取出角色
  ↓
performRoleAction(role, players)  // 執行該角色的行動
  ↓
  ├─ handleWerewolfAction(players)
  ├─ handleMinionAction(players)
  ├─ handleInsomniacAction(players)
  ├─ handleProphetAction(player)
  ├─ handleRobberAction(player)
  ├─ handleTroublemakerAction(player)
  └─ handleDrunkAction(player)
  ↓
nextNightAction()                 // 角色索引 +1
  ↓ (重複直到所有角色處理完)
endNightPhase()
```

---

## 各角色行動處理邏輯

### 1. 狼人階段
**舊邏輯：**
- 顯示「目前行動：玩家名稱（狼人）」
- 玩家點擊「使用狼人技能」

**新邏輯：**
- 顯示「目前行動：狼人」
- 如果獨狼 → 顯示中心牌選擇
- 如果多狼 → 顯示隊友名單（所有玩家可見）
- **不透露是哪位玩家在行動**

### 2. 爪牙階段
**舊邏輯：**
- 顯示「目前行動：玩家名稱（爪牙）」
- 玩家點擊「使用爪牙技能」

**新邏輯：**
- 顯示「目前行動：爪牙」
- 顯示狼人位置（如果場上有狼人）
- **不透露是哪位玩家在行動**

### 3. 失眠者階段
**舊邏輯：**
- 顯示「目前行動：玩家名稱（失眠者）」
- 玩家點擊「使用失眠者技能」

**新邏輯：**
- 顯示「目前行動：失眠者」
- **為每位失眠者生成隱藏身份的按鈕**
  - 例如：`失眠者1 查看身份`、`失眠者2 查看身份`
- 玩家點擊按鈕後只顯示角色名稱，不顯示玩家姓名
- **防止其他玩家知道是誰在查看**

### 4. 先知階段
**舊邏輯：**
- 顯示「目前行動：玩家名稱（先知）」
- 玩家選擇查驗目標

**新邏輯：**
- 顯示「目前行動：先知」
- 玩家選擇查驗目標
- **只顯示「先知」，不顯示玩家姓名**

### 5. 強盜階段
**舊邏輯：**
- 顯示「目前行動：玩家名稱（強盜）」
- 玩家選擇交換目標

**新邏輯：**
- 顯示「目前行動：強盜」
- 玩家選擇交換目標
- **只顯示「強盜」，不顯示玩家姓名**

### 6. 搗蛋鬼階段
**舊邏輯：**
- 顯示「目前行動：玩家名稱（搗蛋鬼）」
- 玩家選擇兩個交換目標

**新邏輯：**
- 顯示「目前行動：搗蛋鬼」
- 玩家選擇兩個交換目標
- **只顯示「搗蛋鬼」，不顯示玩家姓名**

### 7. 酒鬼階段
**舊邏輯：**
- 顯示「目前行動：玩家名稱（酒鬼）」
- 玩家選擇中心牌交換

**新邏輯：**
- 顯示「目前行動：酒鬼」
- 玩家選擇中心牌交換
- **只顯示「酒鬼」，不顯示玩家姓名**

---

## 身份暴露防護機制

### 1. UI 顯示保護
```html
<!-- 舊：會暴露玩家身份 -->
<h3>目前行動：<span id="night-player-name">玩家3（先知）</span></h3>

<!-- 新：只顯示角色 -->
<h3>目前行動：<span id="night-player-name">先知</span></h3>
```

### 2. 行動觸發保護
- **舊系統**：點擊「使用 [玩家名稱] 技能」按鈕 → 顯示玩家身份
- **新系統**：點擊「使用 [角色名] 技能」按鈕 → 只顯示角色

### 3. 結果顯示保護
```javascript
// 舊：行動結果會提及玩家姓名
result = `與 ${target.name} 交換身份，你現在是: ${currentPlayer.currentRole}`;

// 新：行動結果用角色標籤
contentDiv.textContent = `失眠者${index + 1} 查看自己: ${player.currentRole}`;
```

### 4. 多人角色保護
- **狼人/爪牙**：當多人擁有該角色時，所有擁有者同時獲得資訊
- **失眠者**：為每位失眠者生成隱藏身份的按鈕，點擊後只顯示角色名稱
- **其他角色**：單人行動，其他玩家只看到「角色行動完成」

---

## 流程圖

```
┌─────────────────────────────────────────────────────────────┐
│                   開始夜間行動 (startNightPhase)             │
│                        currentRoleIndex = 0                  │
└─────────────────────────────┬───────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│            處理下一個角色 (processNextNightAction)           │
│        從 ROLE_NIGHT_ORDER 取出 currentRoleIndex 位置的角色   │
└─────────────────────────────┬───────────────────────────────┘
                              ↓
                      ┌──────────────┐
                      │  是否有角色?  │
                      └──────┬───────┘
                             ↓
                    ┌───────┴───────┐
          ┌─────────┴─────────┐     │
          ↓                   ↓     │
      ┌───────┐          ┌─────────┐ │
      │  結束  │          │  找出擁有  │ │
      │  夜間  │          │  該角色的  │ │
      │       │          │  玩家列表  │ │
      └───────┘          └─────────┘ │
          ↑                   ↓     │
          │           ┌─────────────┘ │
          │           │               │
          │           ↓               │
          │    ┌──────────────┐       │
          │    │ 執行角色行動 │       │
          │    │ (performRole │       │
          │    │   Action)    │       │
          │    └──────┬───────┘       │
          │           │               │
          │    ┌──────┴───────┐       │
          │    │ 根據角色類型 │       │
          │    │ 觸發對應函式 │       │
          │    └──────┬───────┘       │
          │           │               │
          │    ┌──────┴───────┐       │
          │    │  更新 UI 顯示  │       │
          │    │  只顯示角色名  │       │
          │    └──────┬───────┘       │
          │           │               │
          │    ┌──────┴───────┐       │
          │    │  等待玩家操作  │       │
          │    │  (選擇目標等)  │       │
          │    └──────┬───────┘       │
          │           │               │
          │    ┌──────┴───────┐       │
          │    │  執行行動結果  │       │
          │    │  顯示行動結果  │       │
          │    └──────┬───────┘       │
          │           │               │
          │    ┌──────┴───────┐       │
          │    │  角色索引+1   │       │
          │    │  (nextNightAction)   │
          │    └───────────────┘       │
          │           ↑               │
          └───────────┴───────────────┘
                              ↓
                    ┌──────────────┐
                    │  處理下一個  │
                    │  角色        │
                    └──────────────┘
```

---

## 關鍵差異總結

| 方面 | 舊系統（玩家順序） | 新系統（角色順序） |
|------|-------------------|-------------------|
| **行動觸發** | 按玩家順序遍歷 | 按角色順序遍歷 |
| **UI 顯示** | 「目前行動：玩家名稱」 | 「目前行動：角色名稱」 |
| **身份暴露** | 高（玩家姓名直接顯示） | 低（只顯示角色名） |
| **失眠者處理** | 無特殊處理 | 隱藏玩家身份，只顯示「失眠者1」、「失眠者2」 |
| **多角色同時** | 不支持（會曝露） | 支持（多人同時行動） |
| **順序控制** | 玩家索引 | 角色索引陣列 |

---

## 使用範例

### 遊戲設定
- 6 名玩家
- 角色配置：狼人x2、爪牙、失眠者、先知、強盜、搗蛋鬼、酒鬼、中心牌x3

### 夜間流程
1. **爪牙階段**（玩家3 是爪牙）
   - 顯示：「目前行動：爪牙」
   - 顯示：狼人在 玩家1、玩家2
   - 玩家3 查看，其他玩家不知道是誰

2. **狼人階段**（玩家1、玩家2 是狼人）
   - 顯示：「目前行動：狼人」
   - 顯示：你的隊友是 玩家1、玩家2
   - 所有玩家看到同一畫面

3. **失眠者階段**（玩家5 是失眠者）
   - 顯示：「目前行動：失眠者」
   - 按鈕：失眠者1 查看身份
   - 點擊後顯示：失眠者1 查看自己：強盜
   - **其他玩家不知道玩家5 是失眠者**

4. **先知階段**（玩家4 是先知）
   - 顯示：「目前行動：先知」
   - 玩家4 選擇查驗目標
   - 顯示：「先知」，不顯示玩家姓名

5. **強盜階段**（玩家6 是強盜）
   - 顯示：「目前行動：強盜」
   - 玩家6 選擇交換目標
   - 顯示：「強盜」，不顯示玩家姓名

6. **搗蛋鬼階段**（玩家7 是搗蛋鬼）
   - 顯示：「目前行動：搗蛋鬼」
   - 玩家7 選擇兩個交換目標
   - 顯示：「搗蛋鬼」，不顯示玩家姓名

7. **酒鬼階段**（玩家8 是酒鬼）
   - 顯示：「目前行動：酒鬼」
   - 玩家8 選擇中心牌交換
   - 顯示：「酒鬼」，不顯示玩家姓名

---

## 總結

### ✅ 完成的改進
1. **消除身份暴露**：UI 只顯示角色名稱，不顯示玩家姓名
2. **正確的行動順序**：遵循 One Night 規則的角色順序
3. **多人角色支援**：狼人/爪牙可以同時行動
4. **失眠者隱藏**：失眠者查看身份時不會暴露玩家身份

### 📌 關鍵原則
- **所有 UI 顯示使用角色名稱，而非玩家姓名**
- **行動觸發基於角色類型，而非玩家身份**
- **多人角色行動時，所有擁有者同時獲得資訊**
- **行動結果顯示用角色標籤，避免提及玩家**

### 🎯 遊戲體驗提升
- 玩家無法透過 UI 觀察得知其他玩家的身份
- 夜間行動的神秘感得以保持
- 符合原版 One Night Ultimate Werewolf 的遊戲精神