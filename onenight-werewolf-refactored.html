<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸€å¤œç‹¼äººæ®º - å•¤ç‰Œé…’</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Specific styles for onenight-werewolf.html */
        body {
            background-color: var(--dpd-bg-dark);
            color: var(--dpd-text-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            padding: 20px;
            text-align: center;
            box-sizing: border-box;
        }

        h1, h2, h3, .game-card h3 {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 700;
            color: #10b981;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            letter-spacing: 0.5px;
        }
        .game-card {
            background: linear-gradient(145deg, #047857, #065f46);
            border: 3px solid #10b981;
            box-shadow: 0 8px 25px rgba(16,185,129,0.3);
        }

        .setup {
            background: linear-gradient(135deg, #0f766e, #115e59);
            padding: 25px;
            border-radius: 20px;
            border: 3px solid #10b981;
            box-shadow: 0 15px 40px rgba(16,185,129,0.3);
            margin: 20px 0;
            width: 90%;
            max-width: 700px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-section {
            background: linear-gradient(145deg, #047857, #065f46);
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(16,185,129,0.3);
            padding: 30px;
            margin-bottom: 20px;
            width: 90%;
            max-width: 700px;
            box-sizing: border-box;
        }

        .setup select, .setup button, .setup input {
            margin: 10px;
            padding: 8px 15px;
            border-radius: 8px;
            border: 2px solid #10b981;
            background: #065f46;
            color: white;
            font-size: 14px;
        }

        .config-btn {
            padding: 12px 25px;
            margin: 0 10px;
            border: none;
            border-radius: 50px;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            cursor: pointer;
        }

        .config-btn.green {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
        }
        .config-btn.blue {
            background: linear-gradient(45deg, #3b82f6, #2563eb);
            color: white;
        }
        .config-btn.gold {
            background: linear-gradient(45deg, #facc15, #eab308);
            color: #1f2937;
        }
        .config-btn.red {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            color: white;
        }

        .config-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }
        .config-btn:disabled {
            background: #6c757d;
            color: #ccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* Night Phase Styles */
        .night-phase {
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            padding: 30px;
            border-radius: 25px;
            margin: 20px 0;
            border: 4px solid #3b82f6;
            width: 90%;
            max-width: 700px;
            box-sizing: border-box;
        }

        .night-phase h2 {
            color: #60a5fa;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 10px;
        }

        .current-night-player {
            background: rgba(96, 165, 250, 0.2);
            border: 2px solid #60a5fa;
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
        }

        .night-actions {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .night-btn {
            flex: 1;
            min-width: 120px;
            padding: 15px;
            margin: 5px;
            background: rgba(255,255,255,0.1);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 15px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .night-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }

        .night-btn:disabled {
            background: #6c757d;
            color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .night-btn.executed {
            opacity: 0.6;
            background: linear-gradient(45deg, #495057, #6c757d);
            cursor: default;
        }

        .night-btn.skipped {
            opacity: 0.4;
            background: linear-gradient(45deg, #adb5bd, #ced4da);
            color: #343a40;
            cursor: default;
        }

        .action-panel {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
            text-align: left;
        }

        .action-panel h4 {
            color: #fbc02d;
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px dashed rgba(255,255,255,0.3);
            padding-bottom: 8px;
        }

        .select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .select-btn {
            padding: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
        }

        .select-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }

        .select-btn.selected {
            background: linear-gradient(45deg, #10b981, #059669);
            border-color: #10b981;
        }

        .action-result {
            background: linear-gradient(135deg, #1e40af, #1d4ed8);
            border: 3px solid #60a5fa;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            animation: pulse 0.5s;
        }

        .action-result h4 {
            color: #fbc02d;
            margin-top: 0;
        }

        /* Day Phase & Voting */
        .voting-area {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .vote-btn {
            padding: 12px 20px;
            background: linear-gradient(45deg, #ef4444, #dc2626);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .vote-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.5);
        }

        .vote-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .discuss-area {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }

        .discuss-area textarea {
            width: 100%;
            height: 100px;
            background: #065f46;
            color: white;
            border: 2px solid #10b981;
            border-radius: 10px;
            padding: 10px;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
        }

        /* Display Areas */
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .player-card, .center-card {
            background-color: var(--dpd-card-bg-darker);
            border: 1px solid var(--dpd-border-gray);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 100px;
        }

        .player-card h4, .center-card h4 {
            color: var(--accent-warm-yellow);
            margin: 0 0 8px 0;
            font-size: 1em;
        }

        .player-card p, .center-card p {
            font-size: 0.85em;
            color: var(--dpd-text-light);
            margin: 3px 0;
        }

        .hidden {
            color: #999;
            font-style: italic;
        }

        .final-result {
            font-size: 1.8em;
            color: var(--accent-warm-yellow);
            margin: 30px 0;
            padding: 25px;
            background: linear-gradient(135deg, #065f46, #047857);
            border: 4px solid #10b981;
            border-radius: 20px;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            animation: pulse 0.8s;
        }

        .role-list {
            text-align: left;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .role-list p {
            margin: 5px 0;
            border-bottom: 1px dashed rgba(255,255,255,0.1);
            padding-bottom: 3px;
        }

        /* Animations */
        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .slide-in {
            animation: slideIn 0.5s ease-out;
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 { font-size: 1.8em; }
            .config-btn { padding: 10px 15px; font-size: 14px; }
            .night-btn { min-width: 90px; font-size: 12px; padding: 10px; }
            .select-grid { grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); }
        }

        footer {
            margin-top: 40px;
            margin-bottom: 20px;
            color: #888;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-button">è¿”ä¸»é </a>
    <h1>ä¸€å¤œç‹¼äººæ®º (3-10äºº)</h1>
    <p style="font-size: 0.9em; color: #aaa; margin-top: 5px;">é©ç”¨æ–¼3-10åç©å®¶</p>

    <!-- æº–å‚™å€ -->
    <div class="setup">
      <select id="playerCount" onchange="updatePlayerCount(this.value)">
        <option value="3">3äºº</option>
        <option value="4">4äºº</option>
        <option value="5">5äºº</option>
        <option value="6" selected>6äºº</option>
        <option value="7">7äºº</option>
        <option value="8">8äºº</option>
        <option value="9">9äºº</option>
        <option value="10">10äºº</option>
      </select>

      <div class="name-inputs" style="display:none;">
        <h4>è¼¸å…¥ç©å®¶åå­—ï¼ˆå¯é¸ï¼‰ï¼š</h4>
        <input id="name1" placeholder="ç©å®¶1">
        <input id="name2" placeholder="ç©å®¶2">
        <input id="name3" placeholder="ç©å®¶3">
        <input id="name4" placeholder="ç©å®¶4">
        <input id="name5" placeholder="ç©å®¶5">
        <input id="name6" placeholder="ç©å®¶6">
        <input id="name7" placeholder="ç©å®¶7">
        <input id="name8" placeholder="ç©å®¶8">
        <input id="name9" placeholder="ç©å®¶9">
        <input id="name10" placeholder="ç©å®¶10">
      </div>

      <button onclick="loadRecommended()" class="config-btn green">æ¨è–¦é…ç½®</button>
      <button onclick="dealCards()" class="config-btn gold">ç™¼ç‰Œ</button>
    </div>

    <!-- éŠæˆ²å€åŸŸ -->
    <div id="game-area" style="display:none;">
      
      <!-- è§’è‰²æŸ¥çœ‹å€ -->
      <div id="roleview-phase" class="game-section" style="display:none;">
        <h2>ğŸƒ è§’è‰²æŸ¥çœ‹</h2>
        
        <p style="margin-bottom: 20px; color: #ccc;">æ¯ä½ç©å®¶é»æ“Šè‡ªå·±çš„åå­—æŸ¥çœ‹ç§äººè§’è‰²</p>
        
        <div class="players-grid" style="margin-bottom: 25px;">
          <!-- Player buttons will be inserted here -->
        </div>

        <div id="private-role-display" style="display: none; margin-bottom: 20px;">
          <div class="setup">
            <h3 style="color: var(--accent-warm-yellow);">ä½ çš„ç§äººè§’è‰²</h3>
            <div id="private-role-name" style="font-size: 2em; font-weight: bold; color: #10b981; margin: 15px 0;">
              <!-- Will be filled by JS -->
            </div>
            <p id="private-role-camp" style="font-size: 1.2em; color: #fbc02d;"></p>
            <p id="private-role-skill" style="font-size: 1em; color: #ccc; margin-top: 10px;"></p>
            
            <!-- æ–°å¢ï¼šä¿®æ”¹åå­—åŠŸèƒ½ -->
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed rgba(255,255,255,0.3);">
              <p style="font-size: 0.9em; color: #ccc; margin-bottom: 8px;">ä¿®æ”¹åå­—ï¼ˆå¯é¸ï¼‰ï¼š</p>
              <input id="change-name-input" type="text" placeholder="è¼¸å…¥æ–°åå­—" style="padding: 8px; border-radius: 8px; border: 2px solid #10b981; background: #065f46; color: white; font-size: 14px; width: 200px;">
              <button onclick="changePlayerName()" class="config-btn green" style="margin-left: 10px; padding: 8px 15px; font-size: 14px;">ä¿å­˜</button>
            </div>
            
            <!-- æ–°å¢ï¼šé—œé–‰æŒ‰éˆ• -->
            <button onclick="hidePrivateRoleDisplay()" class="config-btn red" style="margin-top: 15px;">é—œé–‰</button>
          </div>
        </div>

        <div style="margin-top: 20px; text-align: center;">
          <button id="finish-view-btn" onclick="finishRoleView()" class="config-btn green" style="display: none;">æŸ¥çœ‹å®Œç•¢</button>
        </div>
      </div>

      <!-- å¤œé–“è¡Œå‹•å€ -->
      <div id="night-phase" class="night-phase" style="display:none;">
        <h2>ğŸŒ™ å¤œé–“è¡Œå‹•</h2>
        
        <div id="current-night-player" class="current-night-player">
          <h3>ç›®å‰è¡Œå‹•ï¼š<span id="night-player-name"></span></h3>
          <p id="night-role-description"></p>
        </div>
        
        <div id="night-actions-container" class="night-actions">
          <!-- Action buttons will be inserted here -->
        </div>

        <div id="action-panel" class="action-panel" style="display:none;">
          <h4 id="action-title">é¸æ“‡ç›®æ¨™</h4>
          <div id="selection-area">
            <!-- Selection options will be inserted here -->
          </div>
          <div style="margin-top: 15px; text-align: center;">
            <button onclick="executeAction()" class="config-btn blue">ç¢ºèªè¡Œå‹•</button>
          </div>
        </div>

        <div id="action-result" class="action-result" style="display:none;">
          <h4>è¡Œå‹•çµæœ</h4>
          <div id="result-content"></div>
        </div>

        <div style="margin-top: 20px; text-align: center;">
          <button onclick="nextNightAction()" class="config-btn green">ä¸‹ä¸€è§’è‰²</button>
        </div>
      </div>

      <!-- æ—¥é–“/æŠ•ç¥¨å€ -->
      <div id="day-phase" class="game-section" style="display:none;">
        <h2>â˜€ï¸ æ—¥é–“è¨è«– & æŠ•ç¥¨</h2>
        
        <div class="discuss-area">
          <h4>è¨è«–å€ (å¯é¸)</h4>
          <textarea id="discussion-text" placeholder="è¼¸å…¥ä½ çš„è§€å¯Ÿæˆ–æ¨ç†..."></textarea>
        </div>

        <h3>ğŸ¯ æŠ•ç¥¨éšæ®µ</h3>
        <p>é¸æ“‡ä½ æƒ³æ”¾é€çš„ç©å®¶ï¼š</p>
        <div id="voting-area" class="voting-area">
          <!-- Voting buttons will be inserted here -->
        </div>

        <div id="voting-result" style="display:none; margin-top: 20px;">
          <h3>æŠ•ç¥¨çµæœ</h3>
          <div id="votes-display"></div>
        </div>

        <div style="margin-top: 20px; text-align: center;">
          <button onclick="endGame()" class="config-btn gold">çµæŸéŠæˆ² & æŸ¥çœ‹çµæœ</button>
        </div>
      </div>

      <!-- çµæœå€ -->
      <div id="results-section" class="game-section" style="display:none;">
        <h2>ğŸ† éŠæˆ²çµæœ</h2>
        <div id="final-result" class="final-result"></div>
        
        <h3>æœ€çµ‚èº«ä»½æ­ç¤º</h3>
        <div id="final-roles" class="players-grid"></div>

        <h3>ä¸­å¿ƒç‰Œå±•ç¤º</h3>
        <div id="center-cards-final" class="players-grid"></div>

        <div id="detailed-explanation" class="role-list"></div>
      </div>
    </div>

    <details style="margin-top: 30px; width: 90%; max-width: 700px;" class="game-section">
        <summary style="font-size: 1.2em; font-weight: bold; color: var(--accent-warm-yellow); cursor: pointer; padding: 10px 0;">è§’è‰²æŠ€èƒ½è©³è§£</summary>
        <div id="skill-list" style="text-align: left; padding-top: 10px;">
            <!-- Skills will be populated here by JS -->
        </div>
    </details>

    <footer>
        <p>å•¤ç‰Œé…’ gameğŸ» - ä¸€å¤œç‹¼äººæ®º</p>
    </footer>

    <script>
        const ROLES = {
            'åŒ–èº«å¹½éˆ': { camp: 'å¥½äºº', skill: 'åŒ–èº«ç‚ºå¦ä¸€åç©å®¶çš„èº«ä»½ï¼Œä¸¦åŸ·è¡Œè©²èº«ä»½çš„æŠ€èƒ½ï¼ˆå¯é¸æ“‡æ˜¯å¦åŸ·è¡Œï¼‰ã€‚', nightOrder: 1 },
            'ç‹¼äºº': { camp: 'ç‹¼äºº', skill: 'çœçœ¼äº’ç›¸ç¢ºèªã€‚è‹¥åªæœ‰ä¸€éš»ç‹¼ï¼Œå¯æŸ¥çœ‹æ¡Œé¢ä¸Šä¸‰å¼µç‰Œä¸­çš„ä¸€å¼µã€‚', nightOrder: 2 },
            'çˆªç‰™': { camp: 'ç‹¼äºº', skill: 'çœçœ¼ç¢ºèªç‹¼äººï¼ˆç‹¼äººè±èµ·å¤§æ‹‡æŒ‡ï¼‰ã€‚', nightOrder: 3 },
            'å®ˆå¤œäºº': { camp: 'å¥½äºº', skill: 'æŸ¥çœ‹ä¸€åç©å®¶æ˜¯å¦ç‚ºå®ˆå¤œäººï¼Œè‹¥ä¸æ˜¯å‰‡æŸ¥çœ‹å…¶èº«ä»½ã€‚', nightOrder: 4 },
            'å…ˆçŸ¥': { camp: 'å¥½äºº', skill: 'æŸ¥çœ‹ä¸€åç©å®¶çš„ç‰Œï¼Œæˆ–ä¸­å¤®å…©å¼µç‰Œã€‚', nightOrder: 5 },
            'å¼·ç›œ': { camp: 'å¥½äºº', skill: 'èˆ‡ä¸€åç©å®¶äº¤æ›èº«åˆ†ï¼Œä¸¦æŸ¥çœ‹äº¤æ›å¾Œçš„æ–°ç‰Œã€‚', nightOrder: 6 },
            'æ—è›‹é¬¼': { camp: 'å¥½äºº', skill: 'äº¤æ›å…©åç©å®¶çš„ç‰Œï¼Œä½†ä¸æŸ¥çœ‹ã€‚', nightOrder: 7 },
            'é…’é¬¼': { camp: 'å¥½äºº', skill: 'èˆ‡ä¸­å¤®ç‰Œäº¤æ›ï¼Œä¸èƒ½çœ‹è‡ªå·±æ‹¿åˆ°çš„ç‰Œã€‚', nightOrder: 8 },
            'å¤±çœ è€…': { camp: 'å¥½äºº', skill: 'æœ€å¾Œé†’ä¾†æŸ¥çœ‹è‡ªå·±çš„ç‰Œï¼ˆè‹¥è¢«å¼·ç›œæˆ–æ—è›‹é¬¼æ›éï¼Œæœƒç™¼ç¾ï¼‰ã€‚', nightOrder: 9 }
        };

        const RECOMMENDED_CONFIGS = {
            3: ['ç‹¼äºº','ç‹¼äºº','å…ˆçŸ¥'],
            4: ['ç‹¼äºº','ç‹¼äºº','å…ˆçŸ¥','å¼·ç›œ'],
            5: ['ç‹¼äºº','ç‹¼äºº','å…ˆçŸ¥','å¼·ç›œ','æ—è›‹é¬¼'],
            6: ['ç‹¼äºº','ç‹¼äºº','å…ˆçŸ¥','å¼·ç›œ','æ—è›‹é¬¼','é…’é¬¼','å¤±çœ è€…','çˆªç‰™'],
            7: ['ç‹¼äºº','ç‹¼äºº','å…ˆçŸ¥','å¼·ç›œ','æ—è›‹é¬¼','é…’é¬¼','å¤±çœ è€…','çˆªç‰™'],
            8: ['ç‹¼äºº','ç‹¼äºº','å…ˆçŸ¥','å¼·ç›œ','æ—è›‹é¬¼','é…’é¬¼','å¤±çœ è€…','çˆªç‰™'],
            9: ['ç‹¼äºº','ç‹¼äºº','å…ˆçŸ¥','å¼·ç›œ','æ—è›‹é¬¼','é…’é¬¼','å¤±çœ è€…','çˆªç‰™'],
            10:['ç‹¼äºº','ç‹¼äºº','å…ˆçŸ¥','å¼·ç›œ','æ—è›‹é¬¼','é…’é¬¼','å¤±çœ è€…','çˆªç‰™']
        };

        // æ–°å¢ï¼šè§’è‰²å¤œé–“è¡Œå‹•é †åºï¼ˆé—œéµè®Šæ•¸ï¼‰
        const ROLE_NIGHT_ORDER = ['åŒ–èº«å¹½éˆ', 'ç‹¼äºº', 'çˆªç‰™', 'å®ˆå¤œäºº', 'å…ˆçŸ¥', 'å¼·ç›œ', 'æ—è›‹é¬¼', 'å¤±çœ è€…'];

        let state = {
            players: [], // [{ id, name, initialRole, currentRole, hasNightAction, skillUsed }]
            centerCards: [], // [{ id, role }]
            rolesInPlay: [],
            currentPhase: 'setup', // setup, roleview, night, day, results
            currentRoleIndex: 0, // æ”¹ç‚ºè§’è‰²ç´¢å¼•ï¼Œä¸å†æ˜¯ç©å®¶ç´¢å¼•
            selectedTargets: [],
            nightResults: {}, // { playerId: result }
            votes: {}, // { playerId: count }
            actionContext: null // For tracking current action state
        };

        let playerCount = 6;

        // --- Utility Functions ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function getPlayerNames() {
            let names = [];
            for(let i=1; i<=playerCount; i++) {
                const nameInput = document.getElementById(`name${i}`);
                if (nameInput && nameInput.value.trim()) {
                    names.push(nameInput.value.trim());
                } else {
                    names.push(`ç©å®¶${i}`);
                }
            }
            return names;
        }

        function getRoleCamp(role) {
            return ROLES[role] ? ROLES[role].camp : 'æœªçŸ¥';
        }

        function getRoleNightOrder(role) {
            return ROLES[role] ? ROLES[role].nightOrder : -1;
        }

        function getPlayerById(id) {
            return state.players.find(p => p.id === id);
        }

        function getOtherPlayers(currentPlayerId) {
            return state.players.filter(p => p.id !== currentPlayerId);
        }

        // --- UI Functions ---
        function renderRoleSkills() {
            const skillListDiv = document.getElementById('skill-list');
            skillListDiv.innerHTML = '';
            for (const role in ROLES) {
                const p = document.createElement('p');
                p.innerHTML = `<strong style="color: var(--accent-warm-yellow);">${role}:</strong> ${ROLES[role].skill} (${ROLES[role].camp}é™£ç‡Ÿ)`;
                skillListDiv.appendChild(p);
            }
        }

        function updatePlayerCount(count) {
            playerCount = parseInt(count);
            for(let i=1; i<=10; i++) {
                const nameInput = document.getElementById(`name${i}`);
                if (nameInput) {
                    nameInput.style.display = i <= playerCount ? 'inline-block' : 'none';
                }
            }
        }

        function loadRecommended() {
            const configRoles = RECOMMENDED_CONFIGS[playerCount];
            if (configRoles) {
                state.rolesInPlay = [...configRoles];
                alert(`å·²è¼‰å…¥ ${playerCount} äººæ¨è–¦é…ç½®:\n${configRoles.join(', ')}`);
            } else {
                alert('é€™å€‹äººæ•¸æ²’æœ‰æ¨è–¦é…ç½®ï¼Œè«‹é¸æ“‡å…¶ä»–äººæ•¸ã€‚');
            }
        }

        function dealCards() {
            if (!RECOMMENDED_CONFIGS[playerCount]) {
                alert('è«‹å…ˆé¸æ“‡æ¨è–¦é…ç½®äººæ•¸ä¸¦è¼‰å…¥é…ç½®ï¼');
                return;
            }

            // Reset state
            state.players = [];
            state.centerCards = [];
            state.votes = {};
            state.nightResults = {};
            state.selectedTargets = [];
            state.currentRoleIndex = 0;
            state.currentPhase = 'roleview';
            state.actionContext = null;

            const availableRoles = [...RECOMMENDED_CONFIGS[playerCount]];
            const shuffledRoles = shuffleArray(availableRoles);
            const playerNames = getPlayerNames();

            // Distribute player roles
            for (let i = 0; i < playerCount; i++) {
                const role = shuffledRoles.shift();
                state.players.push({
                    id: `p${i + 1}`,
                    name: playerNames[i],
                    initialRole: role,
                    currentRole: role,
                    hasNightAction: ROLES[role] && ROLES[role].nightOrder >= 0,
                    skillUsed: false,
                    nightOrder: getRoleNightOrder(role)
                });
            }

            // Distribute center cards (3 cards)
            for (let i = 0; i < 3; i++) {
                state.centerCards.push({ id: `c${i + 1}`, role: shuffledRoles.shift() });
            }

            // Start role view phase
            document.getElementById('game-area').style.display = 'block';
            startRoleViewPhase();
        }

        let viewedPlayers = new Set();

        function startRoleViewPhase() {
            document.getElementById('roleview-phase').style.display = 'block';
            document.getElementById('night-phase').style.display = 'none';
            document.getElementById('day-phase').style.display = 'none';
            document.getElementById('results-section').style.display = 'none';
            
            // Reset viewed players
            viewedPlayers = new Set();
            
            // Build player grid with view buttons
            const grid = document.querySelector('#roleview-phase .players-grid');
            grid.innerHTML = '';
            
            state.players.forEach((player, index) => {
                const btn = document.createElement('button');
                btn.className = 'config-btn blue';
                btn.textContent = player.name;
                btn.id = `player-btn-${index}`;
                btn.onclick = () => viewPlayerRole(index);
                grid.appendChild(btn);
            });
            
            // Hide private role display and finish button initially
            document.getElementById('private-role-display').style.display = 'none';
            document.getElementById('finish-view-btn').style.display = 'none';
        }

        function viewPlayerRole(playerIndex) {
            const player = state.players[playerIndex];
            
            // Update button appearance to show viewed status
            const btn = document.getElementById(`player-btn-${playerIndex}`);
            if (btn) {
                btn.className = 'config-btn gold';
                btn.textContent = `${player.name} âœ“`;
            }
            
            // Mark player as viewed
            viewedPlayers.add(playerIndex);
            
            // Show private role display (only to the current player)
            const privateRoleDisplay = document.getElementById('private-role-display');
            privateRoleDisplay.style.display = 'block';
            
            // Update the display
            document.getElementById('private-role-name').textContent = player.currentRole;
            document.getElementById('private-role-camp').textContent = `é™£ç‡Ÿ: ${getRoleCamp(player.currentRole)}`;
            document.getElementById('private-role-skill').textContent = `æŠ€èƒ½: ${ROLES[player.currentRole].skill}`;
            
            // Check if all players have viewed
            if (viewedPlayers.size === state.players.length) {
                document.getElementById('finish-view-btn').style.display = 'inline-block';
            }
        }

        // æ–°å¢ï¼šæ‰‹å‹•éš±è—è§’è‰²é¡¯ç¤º
        function hidePrivateRoleDisplay() {
            document.getElementById('private-role-display').style.display = 'none';
        }

        // æ–°å¢ï¼šä¿®æ”¹ç©å®¶åå­—
        function changePlayerName() {
            const input = document.getElementById('change-name-input');
            const newName = input.value.trim();
            
            if (!newName) {
                alert('è«‹è¼¸å…¥åå­—ï¼');
                return;
            }
            
            // æ‰¾å‡ºç•¶å‰æŸ¥çœ‹çš„ç©å®¶
            const viewedPlayerIndex = Array.from(viewedPlayers).pop();
            if (viewedPlayerIndex === undefined) {
                alert('è«‹å…ˆæŸ¥çœ‹è§’è‰²ï¼');
                return;
            }
            
            const player = state.players[viewedPlayerIndex];
            
            // æ›´æ–°ç©å®¶åå­—
            player.name = newName;
            
            // æ›´æ–°æŒ‰éˆ•æ–‡å­—
            const btn = document.getElementById(`player-btn-${viewedPlayerIndex}`);
            if (btn) {
                btn.textContent = newName;
            }
            
            // æ¸…ç©ºè¼¸å…¥æ¡†
            input.value = '';
            
            alert('åå­—å·²æ›´æ–°ï¼');
        }

        function finishRoleView() {
            document.getElementById('roleview-phase').style.display = 'none';
            startNightPhase();
        }

        // ==================== æ–°å¢ï¼šè§’è‰²é †åºå¤œé–“è¡Œå‹•ç³»çµ± ====================
        
        function startNightPhase() {
            document.getElementById('night-phase').style.display = 'block';
            document.getElementById('day-phase').style.display = 'none';
            document.getElementById('results-section').style.display = 'none';
            
            state.currentRoleIndex = 0;  // å¾ç¬¬ä¸€å€‹è§’è‰²é–‹å§‹
            processNextNightAction();
        }

        // æ–°å¢ï¼šè™•ç†ä¸‹ä¸€å€‹è§’è‰²çš„è¡Œå‹•
        function processNextNightAction() {
            // å–å¾—ç•¶å‰è¦åŸ·è¡Œçš„è§’è‰²
            const currentRole = ROLE_NIGHT_ORDER[state.currentRoleIndex];
            
            // å¦‚æœæ²’æœ‰æ›´å¤šè§’è‰²ï¼ŒçµæŸå¤œé–“
            if (!currentRole) {
                endNightPhase();
                return;
            }
            
            // æ‰¾å‡ºæ“æœ‰è©²è§’è‰²çš„æ‰€æœ‰ç©å®¶
            const playersWithRole = state.players.filter(p => p.currentRole === currentRole);
            
            // å¦‚æœæœ‰ç©å®¶æ“æœ‰æ­¤è§’è‰²ï¼ŒåŸ·è¡Œè¡Œå‹•
            if (playersWithRole.length > 0) {
                performRoleAction(currentRole, playersWithRole);
            } else {
                // æ²’æœ‰ç©å®¶æœ‰æ­¤è§’è‰²ï¼Œè·³éä¸¦è™•ç†ä¸‹ä¸€å€‹
                state.currentRoleIndex++;
                processNextNightAction();
            }
        }

        // æ–°å¢ï¼šåŸ·è¡Œç‰¹å®šè§’è‰²çš„è¡Œå‹•
        function performRoleAction(role, playersWithRole) {
            // æ›´æ–° UI é¡¯ç¤ºï¼ˆåªé¡¯ç¤ºè§’è‰²åç¨±ï¼Œä¸é¡¯ç¤ºç©å®¶å§“åï¼‰
            document.getElementById('night-player-name').textContent = role;
            document.getElementById('night-role-description').textContent = `æŠ€èƒ½: ${ROLES[role].skill}`;
            
            // é‡ç½®è¡Œå‹•é¢æ¿
            document.getElementById('night-actions-container').style.display = 'flex';
            document.getElementById('action-panel').style.display = 'none';
            document.getElementById('action-result').style.display = 'none';
            state.selectedTargets = [];
            state.actionContext = null;
            
            // æ ¹æ“šè§’è‰²é¡å‹è§¸ç™¼å°æ‡‰è¡Œå‹•
            switch (role) {
                case 'åŒ–èº«å¹½éˆ':
                    handleDoppelgangerAction(playersWithRole[0]); // åªæœ‰ä¸€ä½åŒ–èº«å¹½éˆ
                    break;
                case 'ç‹¼äºº':
                    handleWerewolfAction(playersWithRole);
                    break;
                case 'çˆªç‰™':
                    handleMinionAction(playersWithRole);
                    break;
                case 'å®ˆå¤œäºº':
                    handleWatchmanAction(playersWithRole[0]); // åªæœ‰ä¸€ä½å®ˆå¤œäºº
                    break;
                case 'å¤±çœ è€…':
                    handleInsomniacAction(playersWithRole);
                    break;
                case 'å…ˆçŸ¥':
                    handleProphetAction(playersWithRole[0]); // åªæœ‰ä¸€ä½å…ˆçŸ¥
                    break;
                case 'å¼·ç›œ':
                    handleRobberAction(playersWithRole[0]); // åªæœ‰ä¸€ä½å¼·ç›œ
                    break;
                case 'æ—è›‹é¬¼':
                    handleTroublemakerAction(playersWithRole[0]); // åªæœ‰ä¸€ä½æ—è›‹é¬¼
                    break;
                case 'é…’é¬¼':
                    handleDrunkAction(playersWithRole[0]); // åªæœ‰ä¸€ä½é…’é¬¼
                    break;
                default:
                    showDefaultAction();
                    break;
            }
        }

        // ==================== å„è§’è‰²è¡Œå‹•è™•ç†å‡½å¼ ====================

        // è™•ç†ç‹¼äººè¡Œå‹•
        function handleWerewolfAction(players) {
            const panel = document.getElementById('action-panel');
            const title = document.getElementById('action-title');
            const area = document.getElementById('selection-area');
            const actionsDiv = document.getElementById('night-actions-container');
            
            panel.style.display = 'block';
            actionsDiv.style.display = 'none';
            
            if (players.length === 1) {
                // ç¨ç‹¼ï¼šæŸ¥çœ‹ä¸­å¿ƒç‰Œ
                title.textContent = 'ç‹¼äººï¼šç¨ç‹¼æŸ¥çœ‹ä¸­å¿ƒç‰Œ';
                
                area.innerHTML = '<div class="select-grid" id="center-selection"></div>';
                const grid = document.getElementById('center-selection');
                
                state.centerCards.forEach((card, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'select-btn';
                    btn.textContent = `ä¸­å¿ƒç‰Œ ${index + 1}`;
                    btn.onclick = () => selectTargetForRole(card, btn, 'ç‹¼äºº');
                    grid.appendChild(btn);
                });
            } else {
                // å¤šç‹¼äººï¼šé¡¯ç¤ºéšŠå‹åå–®
                title.textContent = 'ç‹¼äººï¼šéšŠå‹äº’èª';
                
                const teammateNames = players.map(p => p.name).join(', ');
                area.innerHTML = `<p style="font-size: 1.2em; color: #fbc02d;">ä½ çš„éšŠå‹æ˜¯: ${teammateNames}</p>`;
                
                // è‡ªå‹•è¨˜éŒ„è¡Œå‹•çµæœ
                recordRoleAction('ç‹¼äºº', `ç‹¼äººéšŠå‹äº’èª: ${teammateNames}`, players);
            }
        }

        // è™•ç†çˆªç‰™è¡Œå‹•
        function handleMinionAction(players) {
            const panel = document.getElementById('action-panel');
            const title = document.getElementById('action-title');
            const area = document.getElementById('selection-area');
            const actionsDiv = document.getElementById('night-actions-container');
            
            panel.style.display = 'block';
            actionsDiv.style.display = 'none';
            
            title.textContent = 'çˆªç‰™ï¼šæŸ¥çœ‹ç‹¼äººä½ç½®';
            
            const werewolves = state.players.filter(p => p.currentRole === 'ç‹¼äºº');
            
            if (werewolves.length > 0) {
                const wolfNames = werewolves.map(w => w.name).join(', ');
                area.innerHTML = `<p style="font-size: 1.2em; color: #fbc02d;">ç‹¼äººåœ¨: ${wolfNames}</p>`;
                
                // è‡ªå‹•è¨˜éŒ„è¡Œå‹•çµæœ
                recordRoleAction('çˆªç‰™', `çˆªç‰™çŸ¥é“ç‹¼äººä½ç½®: ${wolfNames}`, players);
            } else {
                area.innerHTML = `<p style="font-size: 1.2em; color: #ef4444;">å ´ä¸Šæ²’æœ‰ç‹¼äººï¼</p>`;
                
                // è‡ªå‹•è¨˜éŒ„è¡Œå‹•çµæœ
                recordRoleAction('çˆªç‰™', 'å ´ä¸Šæ²’æœ‰ç‹¼äºº', players);
            }
        }

        // è™•ç†å¤±çœ è€…è¡Œå‹•
        function handleInsomniacAction(players) {
            const panel = document.getElementById('action-panel');
            const title = document.getElementById('action-title');
            const area = document.getElementById('selection-area');
            const actionsDiv = document.getElementById('night-actions-container');
            
            panel.style.display = 'block';
            actionsDiv.style.display = 'none';
            
            title.textContent = 'å¤±çœ è€…ï¼šæŸ¥çœ‹è‡ªå·±çš„èº«ä»½';
            
            // ç‚ºæ¯ä½å¤±çœ è€…ç”ŸæˆæŒ‰éˆ•ï¼ˆéš±è—ç©å®¶èº«ä»½ï¼‰
            area.innerHTML = '<div style="text-align: center;">';
            players.forEach((player, index) => {
                area.innerHTML += `<button class="night-btn" onclick="viewInsomniacIdentity(${index})">å¤±çœ è€…${index + 1} æŸ¥çœ‹èº«ä»½</button>`;
            });
            area.innerHTML += '</div>';
            
            // å„²å­˜å¤±çœ è€…ç©å®¶
            state.actionContext = { insomniacPlayers: players };
        }

        // å–®ç¨æŸ¥çœ‹å¤±çœ è€…èº«ä»½ï¼ˆä¸æœƒæš´éœ²æ˜¯èª°ï¼‰
        function viewInsomniacIdentity(index) {
            if (!state.actionContext || !state.actionContext.insomniacPlayers) return;
            
            const players = state.actionContext.insomniacPlayers;
            const player = players[index];
            
            const resultDiv = document.getElementById('action-result');
            const contentDiv = document.getElementById('result-content');
            
            resultDiv.style.display = 'block';
            
            // åªé¡¯ç¤ºè§’è‰²ï¼Œä¸é¡¯ç¤ºç©å®¶å§“å
            contentDiv.textContent = `å¤±çœ è€…${index + 1} æŸ¥çœ‹è‡ªå·±: ${player.currentRole}`;
            
            // è¨˜éŒ„è¡Œå‹•
            state.nightResults[player.id] = `å¤±çœ è€…æŸ¥çœ‹: ${player.currentRole}`;
            player.skillUsed = true;
            
            // éš±è—è¡Œå‹•æŒ‰éˆ•
            document.getElementById('night-actions-container').style.display = 'none';
            
            // é¡¯ç¤ºä¸‹ä¸€è§’è‰²æŒ‰éˆ•
            const nextBtn = document.querySelector('#night-phase .config-btn.green');
            nextBtn.style.display = 'inline-block';
        }

        // è™•ç†å…ˆçŸ¥è¡Œå‹•
        function handleProphetAction(player) {
            const panel = document.getElementById('action-panel');
            const title = document.getElementById('action-title');
            const area = document.getElementById('selection-area');
            const actionsDiv = document.getElementById('night-actions-container');
            
            panel.style.display = 'block';
            actionsDiv.style.display = 'none';
            
            title.textContent = 'å…ˆçŸ¥ï¼šé¸æ“‡æŸ¥é©—æ–¹å¼';
            
            area.innerHTML = `
                <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 15px;">
                    <button class="select-btn" onclick="setProphetMode('player')">æŸ¥é©—ç©å®¶</button>
                    <button class="select-btn" onclick="setProphetMode('center')">æŸ¥é©—ä¸­å¿ƒç‰Œ</button>
                </div>
                <div id="prophet-selection-area"></div>
            `;
            
            // å„²å­˜å…ˆçŸ¥ç©å®¶
            state.actionContext = { prophetPlayer: player };
        }

        function setProphetMode(mode) {
            const area = document.getElementById('prophet-selection-area');
            area.innerHTML = '';
            
            if (mode === 'player') {
                area.innerHTML = '<div class="select-grid" id="player-selection"></div>';
                const grid = document.getElementById('player-selection');
                
                // é¸æ“‡å…¶ä»–ç©å®¶ï¼ˆæ’é™¤è‡ªå·±ï¼‰
                const otherPlayers = state.players.filter(p => p.id !== state.actionContext.prophetPlayer.id);
                otherPlayers.forEach(player => {
                    const btn = document.createElement('button');
                    btn.className = 'select-btn';
                    btn.textContent = player.name;
                    btn.onclick = () => selectTargetForRole(player, btn, 'å…ˆçŸ¥');
                    grid.appendChild(btn);
                });
            } else if (mode === 'center') {
                area.innerHTML = '<div class="select-grid" id="center-selection"></div>';
                const grid = document.getElementById('center-selection');
                
                state.centerCards.forEach((card, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'select-btn';
                    btn.textContent = `ä¸­å¿ƒç‰Œ ${index + 1}`;
                    btn.onclick = () => selectTargetForRole(card, btn, 'å…ˆçŸ¥');
                    grid.appendChild(btn);
                });
            }
        }

        // è™•ç†å¼·ç›œè¡Œå‹•
        function handleRobberAction(player) {
            const panel = document.getElementById('action-panel');
            const title = document.getElementById('action-title');
            const area = document.getElementById('selection-area');
            const actionsDiv = document.getElementById('night-actions-container');
            
            panel.style.display = 'block';
            actionsDiv.style.display = 'none';
            
            title.textContent = 'å¼·ç›œï¼šé¸æ“‡ä¸€åç©å®¶äº¤æ›èº«ä»½';
            
            area.innerHTML = '<div class="select-grid" id="player-selection"></div>';
            const grid = document.getElementById('player-selection');
            
            // é¸æ“‡å…¶ä»–ç©å®¶
            const otherPlayers = state.players.filter(p => p.id !== player.id);
            otherPlayers.forEach(target => {
                const btn = document.createElement('button');
                btn.className = 'select-btn';
                btn.textContent = target.name;
                btn.onclick = () => selectTargetForRole(target, btn, 'å¼·ç›œ');
                grid.appendChild(btn);
            });
            
            // å„²å­˜å¼·ç›œç©å®¶
            state.actionContext = { robberPlayer: player };
        }

        // è™•ç†æ—è›‹é¬¼è¡Œå‹•
        function handleTroublemakerAction(player) {
            const panel = document.getElementById('action-panel');
            const title = document.getElementById('action-title');
            const area = document.getElementById('selection-area');
            const actionsDiv = document.getElementById('night-actions-container');
            
            panel.style.display = 'block';
            actionsDiv.style.display = 'none';
            
            title.textContent = 'æ—è›‹é¬¼ï¼šé¸æ“‡å…©åç©å®¶äº¤æ›èº«ä»½ï¼ˆé»æ“Šå…©æ¬¡ï¼‰';
            
            area.innerHTML = '<div class="select-grid" id="player-selection"></div><p style="text-align:center; color:#fbc02d;">å·²é¸æ“‡: <span id="selected-names">ç„¡</span></p>';
            const grid = document.getElementById('player-selection');
            
            // é¸æ“‡å…¶ä»–ç©å®¶
            const otherPlayers = state.players.filter(p => p.id !== player.id);
            otherPlayers.forEach(target => {
                const btn = document.createElement('button');
                btn.className = 'select-btn';
                btn.textContent = target.name;
                btn.onclick = () => selectMultiTargetForRole(target, btn, 2, 'æ—è›‹é¬¼');
                grid.appendChild(btn);
            });
            
            // å„²å­˜æ—è›‹é¬¼ç©å®¶
            state.actionContext = { troublemakerPlayer: player };
        }

        // è™•ç†åŒ–èº«å¹½éˆè¡Œå‹•
        function handleDoppelgangerAction(player) {
            const panel = document.getElementById('action-panel');
            const title = document.getElementById('action-title');
            const area = document.getElementById('selection-area');
            const actionsDiv = document.getElementById('night-actions-container');
            
            panel.style.display = 'block';
            actionsDiv.style.display = 'none';
            
            title.textContent = 'åŒ–èº«å¹½éˆï¼šé¸æ“‡ä¸€åç©å®¶è¤‡è£½å…¶èº«ä»½';
            
            area.innerHTML = '<div class="select-grid" id="player-selection"></div>';
            const grid = document.getElementById('player-selection');
            
            // é¸æ“‡å…¶ä»–ç©å®¶
            const otherPlayers = state.players.filter(p => p.id !== player.id);
            otherPlayers.forEach(target => {
                const btn = document.createElement('button');
                btn.className = 'select-btn';
                btn.textContent = target.name;
                btn.onclick = () => selectTargetForRole(target, btn, 'åŒ–èº«å¹½éˆ');
                grid.appendChild(btn);
            });
            
            // å„²å­˜åŒ–èº«å¹½éˆç©å®¶
            state.actionContext = { doppelgangerPlayer: player };
        }

        // è™•ç†å®ˆå¤œäººè¡Œå‹•
        function handleWatchmanAction(player) {
            const panel = document.getElementById('action-panel');
            const title = document.getElementById('action-title');
            const area = document.getElementById('selection-area');
            const actionsDiv = document.getElementById('night-actions-container');
            
            panel.style.display = 'block';
            actionsDiv.style.display = 'none';
            
            title.textContent = 'å®ˆå¤œäººï¼šé¸æ“‡ä¸€åç©å®¶æŸ¥çœ‹';
            
            area.innerHTML = '<div class="select-grid" id="player-selection"></div>';
            const grid = document.getElementById('player-selection');
            
            // é¸æ“‡å…¶ä»–ç©å®¶
            const otherPlayers = state.players.filter(p => p.id !== player.id);
            otherPlayers.forEach(target => {
                const btn = document.createElement('button');
                btn.className = 'select-btn';
                btn.textContent = target.name;
                btn.onclick = () => selectTargetForRole(target, btn, 'å®ˆå¤œäºº');
                grid.appendChild(btn);
            });
            
            // å„²å­˜å®ˆå¤œäººç©å®¶
            state.actionContext = { watchmanPlayer: player };
        }

        // è™•ç†é…’é¬¼è¡Œå‹•
        function handleDrunkAction(player) {
            const panel = document.getElementById('action-panel');
            const title = document.getElementById('action-title');
            const area = document.getElementById('selection-area');
            const actionsDiv = document.getElementById('night-actions-container');
            
            panel.style.display = 'block';
            actionsDiv.style.display = 'none';
            
            title.textContent = 'é…’é¬¼ï¼šé¸æ“‡ä¸€å¼µä¸­å¿ƒç‰Œäº¤æ›';
            
            area.innerHTML = '<div class="select-grid" id="center-selection"></div>';
            const grid = document.getElementById('center-selection');
            
            state.centerCards.forEach((card, index) => {
                const btn = document.createElement('button');
                btn.className = 'select-btn';
                btn.textContent = `ä¸­å¿ƒç‰Œ ${index + 1}`;
                btn.onclick = () => selectTargetForRole(card, btn, 'é…’é¬¼');
                grid.appendChild(btn);
            });
            
            // å„²å­˜é…’é¬¼ç©å®¶
            state.actionContext = { drunkPlayer: player };
        }

        // ==================== é€šç”¨è¡Œå‹•å‡½å¼ ====================

        function showDefaultAction() {
            const panel = document.getElementById('action-panel');
            const title = document.getElementById('action-title');
            const area = document.getElementById('selection-area');
            
            panel.style.display = 'block';
            title.textContent = 'ç„¡ç‰¹æ®Šè¡Œå‹•';
            area.innerHTML = '<p style="color: #ccc;">æ­¤è§’è‰²æ²’æœ‰éœ€è¦é¸æ“‡çš„è¡Œå‹•</p>';
        }

        function selectTargetForRole(target, btnElement, role) {
            // Clear previous selection
            state.selectedTargets = [target];
            
            // Update visual selection
            const allBtns = document.querySelectorAll('.select-btn');
            allBtns.forEach(b => b.classList.remove('selected'));
            if (btnElement) btnElement.classList.add('selected');
        }

        function selectMultiTargetForRole(target, btnElement, maxTargets, role) {
            // Check if already selected
            const index = state.selectedTargets.findIndex(t => t.id === target.id);
            
            if (index > -1) {
                // Deselect
                state.selectedTargets.splice(index, 1);
                btnElement.classList.remove('selected');
            } else {
                // Select
                if (state.selectedTargets.length < maxTargets) {
                    state.selectedTargets.push(target);
                    btnElement.classList.add('selected');
                }
            }
            
            // Update display
            const nameSpan = document.getElementById('selected-names');
            if (nameSpan) {
                const names = state.selectedTargets.map(t => t.name || t.id).join(', ');
                nameSpan.textContent = names || 'ç„¡';
            }
        }

        // åŸ·è¡Œè¡Œå‹•ï¼ˆé€šç”¨ï¼‰
        function executeAction() {
            const resultDiv = document.getElementById('action-result');
            const contentDiv = document.getElementById('result-content');
            
            resultDiv.style.display = 'block';
            
            const currentRole = ROLE_NIGHT_ORDER[state.currentRoleIndex];
            let result = '';
            
            switch (currentRole) {
                case 'åŒ–èº«å¹½éˆ':
                    const doppelgangerTarget = state.selectedTargets[0];
                    if (doppelgangerTarget) {
                        result = `åŒ–èº«å¹½éˆè¤‡è£½äº† ${doppelgangerTarget.name} çš„èº«ä»½: ${doppelgangerTarget.currentRole}`;
                    }
                    break;
                    
                case 'ç‹¼äºº':
                    const wolfTarget = state.selectedTargets[0];
                    if (wolfTarget && state.centerCards.includes(wolfTarget)) {
                        const cardIndex = state.centerCards.findIndex(c => c.id === wolfTarget.id);
                        result = `ç¨ç‹¼æŸ¥çœ‹ä¸­å¿ƒç‰Œ ${cardIndex + 1}: ${wolfTarget.role} (${getRoleCamp(wolfTarget.role)}é™£ç‡Ÿ)`;
                    }
                    break;
                    
                case 'å®ˆå¤œäºº':
                    const watchmanTarget = state.selectedTargets[0];
                    if (watchmanTarget) {
                        if (watchmanTarget.currentRole === 'å®ˆå¤œäºº') {
                            result = `${watchmanTarget.name} ä¹Ÿæ˜¯å®ˆå¤œäºº`;
                        } else {
                            result = `${watchmanTarget.name}: ${watchmanTarget.currentRole} (${getRoleCamp(watchmanTarget.currentRole)}é™£ç‡Ÿ)`;
                        }
                    }
                    break;
                    
                case 'å…ˆçŸ¥':
                    const prophetTarget = state.selectedTargets[0];
                    if (prophetTarget) {
                        if (state.centerCards.includes(prophetTarget)) {
                            const cardIndex = state.centerCards.findIndex(c => c.id === prophetTarget.id);
                            result = `ä¸­å¿ƒç‰Œ ${cardIndex + 1}: ${prophetTarget.role} (${getRoleCamp(prophetTarget.role)}é™£ç‡Ÿ)`;
                        } else {
                            result = `${prophetTarget.name}: ${prophetTarget.currentRole} (${getRoleCamp(prophetTarget.currentRole)}é™£ç‡Ÿ)`;
                        }
                    }
                    break;
                    
                case 'å¼·ç›œ':
                    const robberTarget = state.selectedTargets[0];
                    if (robberTarget) {
                        const currentPlayer = state.actionContext.robberPlayer;
                        const tempRole = currentPlayer.currentRole;
                        currentPlayer.currentRole = robberTarget.currentRole;
                        robberTarget.currentRole = tempRole;
                        result = `èˆ‡ ${robberTarget.name} äº¤æ›èº«ä»½ï¼Œä½ ç¾åœ¨æ˜¯: ${currentPlayer.currentRole}`;
                    }
                    break;
                    
                case 'æ—è›‹é¬¼':
                    if (state.selectedTargets.length === 2) {
                        const p1 = state.selectedTargets[0];
                        const p2 = state.selectedTargets[1];
                        const temp = p1.currentRole;
                        p1.currentRole = p2.currentRole;
                        p2.currentRole = temp;
                        result = `äº¤æ›äº† ${p1.name} å’Œ ${p2.name} çš„èº«ä»½`;
                    } else {
                        result = `éœ€è¦é¸æ“‡å…©åç©å®¶ï¼`;
                    }
                    break;
                    
                case 'é…’é¬¼':
                    const drunkTarget = state.selectedTargets[0];
                    if (drunkTarget) {
                        const cardIndex = state.centerCards.findIndex(c => c.id === drunkTarget.id);
                        result = `ç›²æ›ä¸­å¿ƒç‰Œ ${cardIndex + 1}ï¼Œéš¨æ©Ÿå¾—åˆ°ä¸€å¼µç‰Œ`;
                    }
                    break;
            }
            
            contentDiv.textContent = result;
            
            // è¨˜éŒ„è¡Œå‹•ï¼ˆåªè¨˜éŒ„æ“æœ‰è©²è§’è‰²çš„ç©å®¶ï¼‰
            const playersWithRole = state.players.filter(p => p.currentRole === currentRole && p.skillUsed === false);
            playersWithRole.forEach(p => {
                state.nightResults[p.id] = result;
                p.skillUsed = true;
            });
            
            // é¡¯ç¤ºä¸‹ä¸€è§’è‰²æŒ‰éˆ•
            const nextBtn = document.querySelector('#night-phase .config-btn.green');
            nextBtn.style.display = 'inline-block';
            
            // éš±è—è¡Œå‹•æŒ‰éˆ•
            document.getElementById('night-actions-container').style.display = 'none';
        }

        // æ–°å¢ï¼šè¨˜éŒ„è§’è‰²è¡Œå‹•ï¼ˆçµ±ä¸€è™•ç†ï¼‰
        function recordRoleAction(role, result, players) {
            const resultDiv = document.getElementById('action-result');
            const contentDiv = document.getElementById('result-content');
            
            resultDiv.style.display = 'block';
            contentDiv.textContent = result;
            
            // è¨˜éŒ„æ‰€æœ‰æ“æœ‰è©²è§’è‰²çš„ç©å®¶
            players.forEach(p => {
                state.nightResults[p.id] = result;
                p.skillUsed = true;
            });
            
            // é¡¯ç¤ºä¸‹ä¸€è§’è‰²æŒ‰éˆ•
            const nextBtn = document.querySelector('#night-phase .config-btn.green');
            nextBtn.style.display = 'inline-block';
            
            // éš±è—è¡Œå‹•æŒ‰éˆ•
            document.getElementById('night-actions-container').style.display = 'none';
        }

        // ==================== æµç¨‹æ§åˆ¶å‡½å¼ ====================

        function nextNightAction() {
            // å¢åŠ è§’è‰²ç´¢å¼•
            state.currentRoleIndex++;
            
            // éš±è—çµæœï¼Œé¡¯ç¤ºè¡Œå‹•æŒ‰éˆ•
            document.getElementById('night-actions-container').style.display = 'flex';
            document.getElementById('action-panel').style.display = 'none';
            document.getElementById('action-result').style.display = 'none';
            
            // è™•ç†ä¸‹ä¸€å€‹è§’è‰²
            processNextNightAction();
        }

        function endNightPhase() {
            document.getElementById('night-phase').style.display = 'none';
            startDayPhase();
        }

        function startDayPhase() {
            document.getElementById('day-phase').style.display = 'block';
            state.currentPhase = 'day';
            
            // Setup voting area
            const votingArea = document.getElementById('voting-area');
            votingArea.innerHTML = '';
            
            state.players.forEach(player => {
                const btn = document.createElement('button');
                btn.className = 'vote-btn';
                btn.textContent = `æŠ•ç¥¨çµ¦ ${player.name}`;
                btn.onclick = () => voteForPlayer(player);
                votingArea.appendChild(btn);
            });
        }

        function voteForPlayer(player) {
            if (!state.votes[player.id]) {
                state.votes[player.id] = 0;
            }
            state.votes[player.id]++;
            
            // Disable all vote buttons after voting
            const voteButtons = document.querySelectorAll('.vote-btn');
            voteButtons.forEach(btn => btn.disabled = true);
            
            // Show voting result
            showVotingResult();
        }

        function showVotingResult() {
            const votingResult = document.getElementById('voting-result');
            const votesDisplay = document.getElementById('votes-display');
            
            votingResult.style.display = 'block';
            
            let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">';
            
            state.players.forEach(player => {
                const voteCount = state.votes[player.id] || 0;
                const borderStyle = voteCount > 0 ? 'border: 2px solid #ef4444;' : '';
                html += `<div style="padding: 8px; background: rgba(0,0,0,0.3); border-radius: 8px; ${borderStyle}">
                    <strong>${player.name}</strong><br>
                    ç¥¨æ•¸: ${voteCount}
                </div>`;
            });
            
            html += '</div>';
            
            // Find most voted
            const maxVotes = Math.max(...Object.values(state.votes));
            const eliminated = Object.entries(state.votes)
                .filter(([id, count]) => count === maxVotes && maxVotes > 0)
                .map(([id, count]) => getPlayerById(id).name);
            
            if (eliminated.length > 0) {
                html += `<p style="color: #fbc02d; font-size: 1.2em; margin-top: 15px;">è¢«æ”¾é€: ${eliminated.join(', ')}</p>`;
            } else {
                html += `<p style="color: #999; margin-top: 15px;">ç„¡äººè¢«æ”¾é€</p>`;
            }
            
            votesDisplay.innerHTML = html;
        }

        function endGame() {
            document.getElementById('day-phase').style.display = 'none';
            document.getElementById('results-section').style.display = 'block';
            
            // Determine winner
            const result = determineWinner();
            
            // Display final result
            document.getElementById('final-result').textContent = result.winner;
            
            // Display final roles
            const finalRolesDiv = document.getElementById('final-roles');
            finalRolesDiv.innerHTML = '';
            
            state.players.forEach(player => {
                const card = document.createElement('div');
                card.className = 'player-card';
                card.innerHTML = `
                    <h4>${player.name}</h4>
                    <p>åˆå§‹: ${player.initialRole}</p>
                    <p>æœ€çµ‚: <strong style="color: #fbc02d;">${player.currentRole}</strong></p>
                    <p style="font-size: 0.8em;">${getRoleCamp(player.currentRole)}</p>
                `;
                finalRolesDiv.appendChild(card);
            });
            
            // Display center cards
            const centerCardsDiv = document.getElementById('center-cards-final');
            centerCardsDiv.innerHTML = '';
            
            state.centerCards.forEach(card => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'center-card';
                cardDiv.innerHTML = `
                    <h4>ä¸­å¿ƒç‰Œ ${card.id.replace('c', '')}</h4>
                    <p><strong style="color: #fbc02d;">${card.role}</strong></p>
                    <p style="font-size: 0.8em;">${getRoleCamp(card.role)}</p>
                `;
                centerCardsDiv.appendChild(cardDiv);
            });
            
            // Detailed explanation
            const explanationDiv = document.getElementById('detailed-explanation');
            let explanation = '<h4>å‹åˆ©æ¢ä»¶åˆ†æ:</h4>';
            explanation += `<p><strong>æœ€çµ‚å­˜æ´»è§’è‰²:</strong> ${result.aliveRoles.join(', ')}</p>`;
            explanation += `<p><strong>æ­»äº¡è§’è‰²:</strong> ${result.deadRoles.join(', ')}</p>`;
            explanation += `<p><strong>å‹åˆ©èªªæ˜:</strong> ${result.explanation}</p>`;
            explanationDiv.innerHTML = explanation;
        }

        function determineWinner() {
            const finalRoles = state.players.map(p => p.currentRole);
            const eliminatedVotes = Object.entries(state.votes)
                .filter(([id, count]) => count > 0)
                .sort((a, b) => b[1] - a[1]);
            
            let eliminatedPlayers = [];
            if (eliminatedVotes.length > 0) {
                const maxVotes = eliminatedVotes[0][1];
                eliminatedVotes.forEach(([id, count]) => {
                    if (count === maxVotes) {
                        eliminatedPlayers.push(getPlayerById(id));
                    }
                });
            }
            
            const eliminatedRoles = eliminatedPlayers.map(p => p.currentRole);
            const aliveRoles = state.players
                .filter(p => !eliminatedPlayers.includes(p))
                .map(p => p.currentRole);
            
            // Check win conditions
            const hasWerewolf = finalRoles.includes('ç‹¼äºº');
            const hasMinion = finalRoles.includes('çˆªç‰™');
            const hasTanner = finalRoles.includes('çš®åŒ ');
            const werewolfAlive = finalRoles.includes('ç‹¼äºº') && 
                eliminatedRoles.includes('ç‹¼äºº') === false;
            
            // 1. ç‹¼äººé™£ç‡Ÿå‹åˆ© (æœ‰ç‹¼äººå­˜æ´»)
            if (werewolfAlive) {
                return {
                    winner: 'ğŸº ç‹¼äººé™£ç‡Ÿå‹åˆ©ï¼',
                    aliveRoles,
                    eliminatedRoles,
                    explanation: 'ç‹¼äººå­˜æ´»ï¼Œé™£ç‡Ÿå‹åˆ©ã€‚'
                };
            }
            
            // 2. çˆªç‰™å‹åˆ© (ç„¡ç‹¼äººæ™‚ï¼Œä»»ä½•äººè¢«æ”¾é€ = çˆªç‰™å‹åˆ©)
            if (hasMinion && !hasWerewolf && eliminatedRoles.length > 0) {
                return {
                    winner: 'ğŸƒ çˆªç‰™å‹åˆ©ï¼',
                    aliveRoles,
                    eliminatedRoles,
                    explanation: 'å ´ä¸Šæ²’æœ‰ç‹¼äººï¼Œä½†æœ‰äººè¢«æ”¾é€ï¼Œçˆªç‰™å‹åˆ©ã€‚'
                };
            }
            
            // 3. çš®åŒ å‹åˆ© (çš®åŒ è¢«æ”¾é€ï¼Œä¸”ç‹¼äººæœªå­˜æ´»)
            if (hasTanner && eliminatedRoles.includes('çš®åŒ ') && !werewolfAlive) {
                return {
                    winner: 'ğŸ´ çš®åŒ å‹åˆ©ï¼',
                    aliveRoles,
                    eliminatedRoles,
                    explanation: 'çš®åŒ è¢«æ”¾é€ä¸”ç‹¼äººæœªå­˜æ´»ï¼Œçš®åŒ å•ç‹¬èƒœåˆ©ã€‚'
                };
            }
            
            // 4. å¥½äººé™£ç‡Ÿå‹åˆ©
            if (!werewolfAlive) {
                return {
                    winner: 'ğŸ˜‡ å¥½äººé™£ç‡Ÿå‹åˆ©ï¼',
                    aliveRoles,
                    eliminatedRoles,
                    explanation: 'ç‹¼äººæœªå­˜æ´»ï¼Œå¥½äººé™£ç‡Ÿå‹åˆ©ã€‚'
                };
            }
            
            // 5. å¹³å±€/å…¶ä»–æƒ…æ³
            return {
                winner: 'âš–ï¸ çµæœï¼šå¹³å±€æˆ–ç‰¹æ®Šå‹åˆ©æ¢ä»¶æœªè§¸ç™¼',
                aliveRoles,
                eliminatedRoles,
                explanation: 'æŒ‰ç…§è¦å‰‡ï¼Œæ­¤æƒ…æ³è¦–ç‚ºå¹³å±€ã€‚'
            };
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            renderRoleSkills();
            updatePlayerCount(document.getElementById('playerCount').value);
        });
    </script>
</body>
</html>